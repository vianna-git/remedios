<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Medicamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader-svg { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="date"], input[type="time"], textarea, input[type="number"] {
            min-height: 2.5rem; /* h-10 */
            -webkit-appearance: none;
            appearance: none;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input:focus, select:focus, textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #3b82f6; /* sky-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .time-input-group input[type="time"] {
            max-width: 150px;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="app">
        <header class="bg-sky-600 text-white shadow-lg">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-5 flex flex-col sm:flex-row justify-between items-center">
                <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Gerenciador de Medicamentos</h1>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="messageArea" class="mb-6"></div>
            <div class="mb-8 text-center">
                <button id="toggleFormButton" class="px-6 py-3 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out bg-sky-500 hover:bg-sky-600 focus:outline-none focus:ring-4 focus:ring-sky-300 flex items-center justify-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    Adicionar Novo Medicamento
                </button>
            </div>
            <div id="medicationFormContainer" class="hidden bg-white p-6 rounded-xl shadow-xl mb-10">
                {/* O formulário será injetado aqui */}
            </div>
            <div id="mainLoader" class="flex justify-center items-center min-h-[200px] sm:min-h-[300px]">
                <div class="text-center">
                    <svg class="loader-svg h-12 w-12 text-sky-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-sky-600 text-lg font-medium">Carregando medicamentos...</p>
                </div>
            </div>
            <div id="medicationListContainer">
                {/* A lista será injetada aqui */}
            </div>
            <footer class="bg-slate-800 text-slate-300 text-center py-8 mt-16 rounded-lg">
                <p>&copy; <span id="currentYear"></span> Gerenciador de Medicamentos. Todos os direitos reservados.</p>
                <p class="text-sm text-slate-400 mt-1">Desenvolvido para facilitar seu dia a dia.</p>
            </footer>
        </div>
    </div>

    <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex justify-center items-center hidden z-50 p-4">
        <div class="relative p-6 sm:p-8 bg-white w-full max-w-lg m-auto flex-col flex rounded-xl shadow-2xl">
            <h3 class="text-xl font-semibold mb-5 text-slate-800">Confirmar Exclusão</h3>
            <p class="text-slate-600 mb-8">Tem certeza que deseja excluir este medicamento?</p>
            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="cancelDeleteButton" class="w-full sm:w-auto px-5 py-2.5 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition-colors duration-150 font-medium">Cancelar</button>
                <button id="confirmDeleteButton" class="w-full sm:w-auto px-5 py-2.5 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-150 font-medium">Excluir</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Estado da aplicação
        let medications = [];
        let editingMedicationId = null;
        let medicationToDeleteId = null;

        // Elementos do DOM
        const mainLoaderEl = document.getElementById('mainLoader');
        const messageAreaEl = document.getElementById('messageArea');
        const toggleFormButtonEl = document.getElementById('toggleFormButton');
        const medicationFormContainerEl = document.getElementById('medicationFormContainer');
        const medicationListContainerEl = document.getElementById('medicationListContainer');
        const currentYearEl = document.getElementById('currentYear');
        const deleteConfirmationModalEl = document.getElementById('deleteConfirmationModal');
        const cancelDeleteButtonEl = document.getElementById('cancelDeleteButton');
        const confirmDeleteButtonEl = document.getElementById('confirmDeleteButton');

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        function initializeAppCore() {
            if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
            setupGlobalEventListeners();
            fetchMedications();
        }

        function setupGlobalEventListeners() {
            if(toggleFormButtonEl) {
                toggleFormButtonEl.addEventListener('click', () => {
                    const isFormVisible = !medicationFormContainerEl.classList.contains('hidden');
                    if (isFormVisible) {
                        hideMedicationForm();
                    } else {
                        editingMedicationId = null;
                        renderMedicationForm();
                        showMedicationForm();
                    }
                });
            }
            if(cancelDeleteButtonEl) cancelDeleteButtonEl.addEventListener('click', hideDeleteConfirmationModal);
            if(confirmDeleteButtonEl) confirmDeleteButtonEl.addEventListener('click', processDeleteMedication);
        }

        // --- MANIPULAÇÃO DE DADOS (API Backend) ---
        async function fetchMedications() {
            if(mainLoaderEl) mainLoaderEl.classList.remove('hidden');
            try {
                const response = await fetch('/api/medicamentos');
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }
                const medsData = await response.json();
                medications = medsData;
                renderMedicationList();
            } catch (error) {
                console.error("Erro ao buscar medicamentos:", error);
                displayMessage(`Não foi possível carregar os medicamentos: ${error.message}`, "error");
                medications = [];
                renderMedicationList();
            } finally {
                if(mainLoaderEl) mainLoaderEl.classList.add('hidden');
            }
        }

        async function saveMedicationToAPI(medData) {
            try {
                let response;
                let url = '/api/medicamentos';
                let method = 'POST';

                if (editingMedicationId) {
                    url += `/${editingMedicationId}`;
                    method = 'PUT';
                }

                response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(medData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.message || `Erro ao salvar: ${response.status}`);
                }
                
                displayMessage(editingMedicationId ? "Medicamento atualizado com sucesso!" : "Medicamento adicionado com sucesso!", "success");
                hideMedicationForm();
                editingMedicationId = null;
                fetchMedications();
            } catch (error) {
                console.error("Erro ao salvar medicamento:", error);
                displayMessage(`Ocorreu um erro ao salvar o medicamento: ${error.message}`, "error");
            }
        }

        function confirmDeleteMedication(medId) {
            medicationToDeleteId = medId;
            if(deleteConfirmationModalEl) deleteConfirmationModalEl.classList.remove('hidden');
        }
        
        function hideDeleteConfirmationModal() {
            medicationToDeleteId = null;
            if(deleteConfirmationModalEl) deleteConfirmationModalEl.classList.add('hidden');
        }

        async function processDeleteMedication() {
            if (!medicationToDeleteId) return;
            try {
                const response = await fetch(`/api/medicamentos/${medicationToDeleteId}`, { method: 'DELETE' });
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ message: `Erro HTTP: ${response.status}` }));
                    throw new Error(errorData.message || `Erro ao excluir: ${response.status}`);
                }
                displayMessage("Medicamento excluído com sucesso.", "success");
                fetchMedications();
            } catch (error) {
                console.error("Erro ao excluir medicamento:", error);
                displayMessage(`Ocorreu um erro ao excluir o medicamento: ${error.message}`, "error");
            } finally {
                hideDeleteConfirmationModal();
            }
        }

        // --- RENDERIZAÇÃO DO FORMULÁRIO DE MEDICAMENTO ---
        function renderMedicationForm() {
            const currentMed = editingMedicationId ? medications.find(m => m.id === editingMedicationId) : null;
            
            const startDateValue = currentMed?.start_date ? new Date(currentMed.start_date).toISOString().split('T')[0] : '';
            const endDateValue = currentMed?.end_date ? new Date(currentMed.end_date).toISOString().split('T')[0] : '';
            const descricaoValue = currentMed?.descricao || '';

            const formHTML = `
                <form id="medicationForm" class="space-y-6">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-6 pb-3 border-b border-slate-200">${currentMed ? 'Editar Medicamento' : 'Adicionar Novo Medicamento'}</h2>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-slate-700 mb-1">Nome do Medicamento <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" value="${currentMed?.name || ''}" required class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400">
                    </div>

                    <div>
                        <label for="descricao" class="block text-sm font-medium text-slate-700 mb-1">Descrição (opcional)</label>
                        <textarea id="descricao" name="descricao" rows="3" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400">${descricaoValue}</textarea>
                    </div>

                    <fieldset class="border border-slate-300 p-4 rounded-lg">
                        <legend class="text-sm font-medium text-slate-600 px-2">Período do Tratamento</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5 mt-2">
                            <div>
                                <label for="startDate" class="block text-xs font-medium text-slate-600 mb-1">Data de Início <span class="text-red-500">*</span></label>
                                <input type="date" id="startDate" name="startDate" value="${startDateValue}" required class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                            </div>
                            <div>
                                <label for="durationDays" class="block text-xs font-medium text-slate-600 mb-1">Duração (dias)</label>
                                <input type="number" id="durationDays" name="durationDays" min="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                            </div>
                            <div>
                                <label for="endDate" class="block text-xs font-medium text-slate-600 mb-1">Data Final</label>
                                <input type="date" id="endDate" name="endDate" value="${endDateValue}" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                            </div>
                        </div>
                    </fieldset>
                    
                    <fieldset class="border border-slate-300 p-4 rounded-lg">
                        <legend class="text-sm font-medium text-slate-600 px-2">Horários de Administração</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 mt-2 mb-3">
                            <div>
                                <label for="firstDoseTime" class="block text-xs font-medium text-slate-600 mb-1">Horário da Primeira Dose</label>
                                <input type="time" id="firstDoseTime" name="firstDoseTime" class="w-auto px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                            </div>
                            <div>
                                <label for="frequencyHours" class="block text-xs font-medium text-slate-600 mb-1">Frequência (a cada X horas)</label>
                                <input type="number" id="frequencyHours" name="frequencyHours" min="1" max="24" class="w-auto px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                            </div>
                        </div>
                        <div id="timesContainer" class="space-y-2">
                            ${(currentMed?.times && currentMed.times.length > 0 ? currentMed.times : ['']).map(time => `
                                <div class="flex items-center space-x-2 time-input-group">
                                    <input type="time" name="times" value="${time}" class="w-auto px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                                    <button type="button" class="removeTimeButton p-1.5 text-red-500 hover:text-red-700 rounded-md hover:bg-red-100 transition-colors" aria-label="Remover Horário">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" id="addTimeButton" class="mt-2 text-xs text-sky-600 hover:text-sky-800 font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            Adicionar Horário Manualmente
                        </button>
                    </fieldset>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-6 gap-y-5 pt-2">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantidade</label>
                            <input type="number" id="quantity" name="quantity" value="${currentMed?.quantity || 1}" min="0.1" step="0.1" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm placeholder-slate-400">
                        </div>
                        <div>
                            <label for="formType" class="block text-sm font-medium text-slate-700 mb-1">Forma</label>
                            <select id="formType" name="formType" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm bg-white">
                                <option value="comprimido" ${currentMed?.form === 'comprimido' ? 'selected' : ''}>Comprimido</option>
                                <option value="liquido" ${currentMed?.form === 'liquido' ? 'selected' : ''}>Líquido</option>
                                <option value="bombinha" ${currentMed?.form === 'bombinha' ? 'selected' : ''}>Bombinha</option>
                            </select>
                        </div>
                        <div>
                            <label for="unit" class="block text-sm font-medium text-slate-700 mb-1">Unidade</label>
                            <select id="unit" name="unit" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm bg-white"></select>
                        </div>
                    </div>

                    <div class="flex items-center pt-2">
                        <input type="checkbox" id="isRegular" name="isRegular" ${currentMed?.is_regular ? 'checked' : ''} class="h-4 w-4 text-sky-600 border-slate-300 rounded focus:ring-2 focus:ring-sky-500">
                        <label for="isRegular" class="ml-2 block text-sm text-slate-800">Medicamento de uso regular/contínuo</label>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-4 pt-5">
                        <button type="button" id="cancelFormButton" class="w-full sm:w-auto px-6 py-2.5 border border-slate-300 rounded-lg text-sm font-semibold text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="w-full sm:w-auto px-6 py-2.5 bg-sky-500 text-white rounded-lg text-sm font-semibold hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-colors flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            ${currentMed ? 'Salvar Alterações' : 'Adicionar Medicamento'}
                        </button>
                    </div>
                </form>
            `;
            if(medicationFormContainerEl) medicationFormContainerEl.innerHTML = formHTML;
            
            const formElement = document.getElementById('medicationForm');
            if(formElement) formElement.addEventListener('submit', handleFormSubmit);
            
            const startDateInput = document.getElementById('startDate');
            const durationDaysInput = document.getElementById('durationDays');
            const endDateInput = document.getElementById('endDate');
            const firstDoseTimeInput = document.getElementById('firstDoseTime');
            const frequencyHoursInput = document.getElementById('frequencyHours');

            if(startDateInput && durationDaysInput && endDateInput) {
                startDateInput.addEventListener('change', () => calculateEndDate(startDateInput, durationDaysInput, endDateInput));
                durationDaysInput.addEventListener('input', () => calculateEndDate(startDateInput, durationDaysInput, endDateInput));
                endDateInput.addEventListener('change', () => { if(durationDaysInput) durationDaysInput.value = ''; });
            }

            if(firstDoseTimeInput && frequencyHoursInput) {
                firstDoseTimeInput.addEventListener('change', () => populateTimesBasedOnFrequency(firstDoseTimeInput, frequencyHoursInput));
                frequencyHoursInput.addEventListener('input', () => populateTimesBasedOnFrequency(firstDoseTimeInput, frequencyHoursInput));
            }
            
            const addTimeBtn = document.getElementById('addTimeButton');
            if(addTimeBtn) addTimeBtn.addEventListener('click', () => {
                addTimeFieldToForm();
                if(firstDoseTimeInput) firstDoseTimeInput.value = '';
                if(frequencyHoursInput) frequencyHoursInput.value = '';
            });

            document.querySelectorAll('.removeTimeButton').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    removeTimeFieldFromForm(e.currentTarget.closest('.time-input-group'));
                    if(firstDoseTimeInput) firstDoseTimeInput.value = '';
                    if(frequencyHoursInput) frequencyHoursInput.value = '';
                });
            });
            document.querySelectorAll('#timesContainer input[name="times"]').forEach(timeInput => {
                timeInput.addEventListener('change', () => {
                    if(firstDoseTimeInput) firstDoseTimeInput.value = '';
                    if(frequencyHoursInput) frequencyHoursInput.value = '';
                });
            });

            const cancelBtn = document.getElementById('cancelFormButton');
            if(cancelBtn) cancelBtn.addEventListener('click', hideMedicationForm);
            
            const formTypeSelect = document.getElementById('formType');
            if(formTypeSelect) {
                 formTypeSelect.addEventListener('change', updateUnitOptionsBasedOnFormType);
                 updateUnitOptionsBasedOnFormType();
            }
        }
        
        function calculateEndDate(startDateInput, durationDaysInput, endDateInput) {
            const startDateString = startDateInput.value;
            const duration = parseInt(durationDaysInput.value, 10);

            if (startDateString && duration > 0) {
                const startDate = new Date(startDateString + "T00:00:00");
                if (isNaN(startDate.getTime())) return;

                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + duration -1);

                endDateInput.value = endDate.toISOString().split('T')[0];
            }
        }

        function populateTimesBasedOnFrequency(firstDoseTimeInput, frequencyHoursInput) {
            const firstDoseString = firstDoseTimeInput.value;
            const frequency = parseInt(frequencyHoursInput.value, 10);
            const timesContainer = document.getElementById('timesContainer');

            if (!firstDoseString || !frequency || frequency <= 0 || !timesContainer) {
                return;
            }

            timesContainer.innerHTML = ''; // Limpa horários existentes

            let [hours, minutes] = firstDoseString.split(':').map(Number);
            
            // Loop para gerar horários dentro de um ciclo de 24h a partir da primeira dose
            for (let i = 0; (i * frequency) < 24; i++) {
                const currentTotalMinutes = (hours * 60 + minutes) + (i * frequency * 60);
                const displayHour = Math.floor(currentTotalMinutes / 60) % 24;
                const displayMinute = currentTotalMinutes % 60;
                
                const timeString = `${String(displayHour).padStart(2, '0')}:${String(displayMinute).padStart(2, '0')}`;
                addTimeFieldToForm(timeString, false); // false para não limpar campos de frequência ao adicionar
            }
        }


        function updateUnitOptionsBasedOnFormType() {
            const formTypeSelect = document.getElementById('formType');
            const unitSelect = document.getElementById('unit');
            if (!formTypeSelect || !unitSelect) return;
            const currentFormType = formTypeSelect.value;
            const currentMed = editingMedicationId ? medications.find(m => m.id === editingMedicationId) : null;
            let selectedUnit = unitSelect.value; 
            
            if (currentMed && currentMed.form === currentFormType) {
                selectedUnit = currentMed.unit;
            } else {
                 if (currentFormType === 'comprimido') selectedUnit = 'unidade';
                 else if (currentFormType === 'liquido') selectedUnit = 'ml';
                 else if (currentFormType === 'bombinha') selectedUnit = 'jato';
                 else selectedUnit = 'unidade';
            }

            unitSelect.innerHTML = '';

            if (currentFormType === 'comprimido') {
                unitSelect.add(new Option('Unidade(s)', 'unidade'));
                selectedUnit = 'unidade';
            } else if (currentFormType === 'liquido') {
                unitSelect.add(new Option('ml', 'ml'));
                unitSelect.add(new Option('Gotas', 'gotas'));
                if (selectedUnit === 'unidade' || selectedUnit === 'jato') selectedUnit = 'ml';
            } else if (currentFormType === 'bombinha') {
                unitSelect.add(new Option('Jato(s)', 'jato'));
                selectedUnit = 'jato';
            } else {
                unitSelect.add(new Option('Unidade(s)', 'unidade'));
                selectedUnit = 'unidade';
            }
            unitSelect.value = selectedUnit;
        }

        function addTimeFieldToForm(timeValue = '', clearFrequencyFields = true) {
            const timesContainer = document.getElementById('timesContainer');
            if (!timesContainer) return;

            const newTimeGroup = document.createElement('div');
            newTimeGroup.className = 'flex items-center space-x-2 time-input-group';
            newTimeGroup.innerHTML = `
                <input type="time" name="times" value="${timeValue}" class="w-auto px-3 py-2 border border-slate-300 rounded-lg shadow-sm text-sm">
                <button type="button" class="removeTimeButton p-1.5 text-red-500 hover:text-red-700 rounded-md hover:bg-red-100 transition-colors" aria-label="Remover Horário">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                </button>
            `;
            const removeButton = newTimeGroup.querySelector('.removeTimeButton');
            const timeInput = newTimeGroup.querySelector('input[name="times"]');

            removeButton.addEventListener('click', (e) => {
                removeTimeFieldFromForm(e.currentTarget.closest('.time-input-group'));
                if (clearFrequencyFields) {
                    const firstDoseTimeInput = document.getElementById('firstDoseTime');
                    const frequencyHoursInput = document.getElementById('frequencyHours');
                    if(firstDoseTimeInput) firstDoseTimeInput.value = '';
                    if(frequencyHoursInput) frequencyHoursInput.value = '';
                }
            });
            
            if (clearFrequencyFields) {
                timeInput.addEventListener('change', () => {
                    const firstDoseTimeInput = document.getElementById('firstDoseTime');
                    const frequencyHoursInput = document.getElementById('frequencyHours');
                    if(firstDoseTimeInput) firstDoseTimeInput.value = '';
                    if(frequencyHoursInput) frequencyHoursInput.value = '';
                });
            }

            timesContainer.appendChild(newTimeGroup);
            if (!timeValue && clearFrequencyFields) { // Foca apenas se for um campo novo, adicionado manualmente
                 timeInput.focus();
            }
        }

        function removeTimeFieldFromForm(groupElement) {
            const timesContainer = document.getElementById('timesContainer');
            if (timesContainer && timesContainer.children.length > 1) {
                groupElement.remove();
            } else if (groupElement) {
                const input = groupElement.querySelector('input[name="times"]');
                if (input) input.value = '';
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const name = form.name.value.trim();
            const startDateValue = form.startDate.value;
            const descricao = form.descricao.value.trim();

            if (!name || !startDateValue) {
                displayMessage("Por favor, preencha o nome e a data de início do medicamento.", "error");
                form.name.focus();
                return;
            }
            const timeInputs = form.querySelectorAll('input[name="times"]');
            const times = Array.from(timeInputs).map(input => input.value.trim()).filter(time => time !== '');
            
            const medicationData = {
                name,
                descricao: descricao || null,
                startDate: startDateValue,
                endDate: form.endDate.value ? form.endDate.value : null,
                times: times.length > 0 ? times : [],
                isRegular: form.isRegular.checked,
                quantity: parseFloat(form.quantity.value) || 1,
                form: form.formType.value,
                unit: form.unit.value,
            };
            saveMedicationToAPI(medicationData);
        }

        function showMedicationForm() {
            if(medicationFormContainerEl) medicationFormContainerEl.classList.remove('hidden');
            if(toggleFormButtonEl) {
                toggleFormButtonEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                    Fechar Formulário`;
                toggleFormButtonEl.classList.replace('bg-sky-500', 'bg-red-500');
                toggleFormButtonEl.classList.replace('hover:bg-sky-600', 'hover:bg-red-600');
                toggleFormButtonEl.classList.replace('focus:ring-sky-300', 'focus:ring-red-300');
            }
            const nameInput = document.getElementById('name');
            if(nameInput) nameInput.focus();
        }
        function hideMedicationForm() {
             if(medicationFormContainerEl) {
                 medicationFormContainerEl.classList.add('hidden');
                 medicationFormContainerEl.innerHTML = ''; 
            }
            editingMedicationId = null; 
            if(toggleFormButtonEl) {
                toggleFormButtonEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    Adicionar Novo Medicamento`;
                toggleFormButtonEl.classList.replace('bg-red-500','bg-sky-500');
                toggleFormButtonEl.classList.replace('hover:bg-red-600', 'hover:bg-sky-600');
                toggleFormButtonEl.classList.replace('focus:ring-red-300', 'focus:ring-sky-300');
            }
        }

        function renderMedicationList() {
            if (!medicationListContainerEl) return;
            if (medications.length === 0 && mainLoaderEl.classList.contains('hidden')) {
                 medicationListContainerEl.innerHTML = `
                    <div class="text-center py-12 px-6 bg-white rounded-xl shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 mb-5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M8 14h0"></path><path d="M12 14h0"></path><path d="M16 14h0"></path><path d="M8 18h0"></path><path d="M12 18h0"></path><path d="M16 18h0"></path></svg>
                        <h3 class="text-xl font-semibold text-slate-700 mb-2">Nenhum medicamento cadastrado.</h3>
                        <p class="text-slate-500">Adicione medicamentos usando o botão acima.</p>
                    </div>`;
                return;
            } else if (medications.length === 0 && !mainLoaderEl.classList.contains('hidden')) {
                return;
            }

            const groupedMedications = groupMedicationsByTime(medications);
            let listHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-semibold text-sky-700">Seus Medicamentos</h2>
                    <button id="exportButton" class="w-full sm:w-auto px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 flex items-center justify-center text-sm font-medium transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        Exportar Lista
                    </button>
                </div>
                <div id="copiedMessage" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-lg text-center font-medium">
                    Lista copiada para a área de transferência!
                </div>`;

            Object.entries(groupedMedications).forEach(([time, medsInTime]) => {
                listHTML += `
                    <div class="mb-8 p-5 sm:p-6 bg-white rounded-xl shadow-lg">
                        <h3 class="text-xl font-semibold text-sky-600 mb-5 flex items-center border-b border-slate-200 pb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2.5 text-sky-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            Horário: ${time}
                        </h3>
                        <div class="space-y-5">`;
                medsInTime.forEach(med => {
                    listHTML += `
                        <div class="p-4 border border-slate-200 rounded-lg hover:shadow-md transition-shadow duration-150">
                            <div class="flex flex-col sm:flex-row justify-between items-start gap-3">
                                <div class="flex-grow">
                                    <h4 class="text-lg font-semibold text-slate-800">${med.name}</h4>
                                    ${med.descricao ? `<p class="text-sm text-slate-500 mt-1 mb-2 whitespace-pre-wrap">${med.descricao}</p>` : ''}
                                    <p class="text-xs text-slate-600">
                                        ${med.quantity} ${med.unit}${med.form === 'comprimido' && parseFloat(med.quantity) !== 1 && med.unit === 'unidade' ? 's' : ''}${med.form === 'liquido' && parseFloat(med.quantity) !== 1 && med.unit === 'gotas' ? 's' : ''}${med.form === 'bombinha' && parseFloat(med.quantity) !== 1 && med.unit === 'jato' ? 's' : ''}
                                        (${med.form === 'bombinha' ? 'jato' : med.form})
                                    </p>
                                    <p class="text-xs text-slate-500 mt-1.5 flex items-center flex-wrap">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1.5 text-slate-400 flex-shrink-0"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        Início: ${formatDateForDisplay(med.start_date)}
                                        ${med.end_date ? `, Fim: ${formatDateForDisplay(med.end_date)}` : ''}
                                        ${med.is_regular ? '<span class="ml-2 mt-1 sm:mt-0 px-2 py-0.5 bg-sky-100 text-sky-700 text-xs font-medium rounded-full inline-block">Uso Contínuo</span>' : ''}
                                    </p>
                                </div>
                                <div class="flex space-x-2 mt-2 sm:mt-0 flex-shrink-0">
                                    <button class="edit-button p-2 text-amber-500 hover:text-amber-600 hover:bg-amber-100 rounded-md transition-colors" data-id="${med.id}" title="Editar" aria-label="Editar ${med.name}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                    <button class="delete-button p-2 text-red-500 hover:text-red-600 hover:bg-red-100 rounded-md transition-colors" data-id="${med.id}" title="Excluir" aria-label="Excluir ${med.name}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                                </div>
                            </div>
                        </div>`;
                });
                listHTML += `</div></div>`;
            });
            medicationListContainerEl.innerHTML = listHTML;
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    editingMedicationId = e.currentTarget.dataset.id;
                    renderMedicationForm();
                    showMedicationForm();
                    if(medicationFormContainerEl) medicationFormContainerEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', (e) => confirmDeleteMedication(e.currentTarget.dataset.id));
            });
            const exportBtn = document.getElementById('exportButton');
            if(exportBtn) exportBtn.addEventListener('click', handleExportList);
        }

        function groupMedicationsByTime(medsArray) {
            const group = {};
            medsArray.forEach(med => {
                const times = med.times && med.times.length > 0 ? med.times : ["Sem Horário Definido"];
                times.forEach(time => {
                    const displayTime = time === "Sem Horário Definido" ? time : formatTimeForDisplay(time);
                    if (!group[displayTime]) {
                        group[displayTime] = [];
                    }
                    group[displayTime].push(med);
                });
            });
            const sortedTimes = Object.keys(group).sort((a, b) => {
                if (a === "Sem Horário Definido") return 1; 
                if (b === "Sem Horário Definido") return -1;
                return a.localeCompare(b); 
            });
            const orderedGroup = {};
            sortedTimes.forEach(time => {
                orderedGroup[time] = group[time];
            });
            return orderedGroup;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn("formatDateForDisplay: Recebeu uma string de data inválida:", dateString);
                return 'N/A (inválida)';
            }
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                timeZone: 'UTC'
            });
        }

        function formatTimeForDisplay(timeString) {
            if (!timeString || !timeString.includes(':')) return "Horário Inválido";
            const [hours, minutes] = timeString.split(':');
            return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
        }

        function displayMessage(message, type = "info") {
            if(!messageAreaEl) return;
            let bgColor = "bg-sky-100";
            let textColor = "text-sky-700";
            let borderColor = "border-sky-500";
            if (type === "success") { bgColor = "bg-green-100"; textColor = "text-green-700"; borderColor = "border-green-500"; }
            if (type === "error") { bgColor = "bg-red-100"; textColor = "text-red-700"; borderColor = "border-red-500"; }
            
            messageAreaEl.innerHTML = `<div class="${bgColor} ${textColor} border-l-4 ${borderColor} p-4 rounded-md shadow-md font-medium">${message}</div>`;
            setTimeout(() => { if(messageAreaEl) messageAreaEl.innerHTML = ''; }, 4500);
        }
        
        function generateExportText() {
            let text = `Lista de Medicamentos\n`;
            text += `Exportado em: ${new Date().toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'})}\n\n`;
            const grouped = groupMedicationsByTime(medications);
            Object.entries(grouped).forEach(([time, medsInTime]) => {
                text += `Horário: ${time}\n`;
                medsInTime.forEach(med => {
                    text += `  - ${med.name} (${med.quantity} ${med.unit}${parseFloat(med.quantity) !== 1 && (med.unit === 'unidade' || med.unit === 'jato') ? 's' : ''})\n`;
                    if (med.descricao) {
                        text += `    Descrição: ${med.descricao}\n`;
                    }
                    text += `    Início: ${formatDateForDisplay(med.start_date)}`;
                    if (med.end_date) {
                        text += `, Fim: ${formatDateForDisplay(med.end_date)}`;
                    }
                    if (med.is_regular) {
                        text += ` (Uso Contínuo)`;
                    }
                    text += `\n`;
                });
                text += '\n';
            });
            return text;
        }

        function handleExportList() {
            if (medications.length === 0) {
                displayMessage("Nenhum medicamento para exportar.", "info");
                return;
            }
            const textToCopy = generateExportText();
            const copiedMessageEl = document.getElementById('copiedMessage');
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            if(copiedMessageEl) copiedMessageEl.classList.remove('hidden');
                            setTimeout(() => { if(copiedMessageEl) copiedMessageEl.classList.add('hidden'); }, 2500);
                        })
                        .catch(err => { 
                            console.warn('Falha ao copiar com navigator.clipboard, tentando fallback:', err);
                            fallbackCopyToClipboard(textToCopy);
                        });
                } else { 
                    fallbackCopyToClipboard(textToCopy);
                }
            } catch (error) {
                console.error('Erro ao copiar para a área de transferência:', error);
                displayMessage('Erro ao copiar. Verifique o console.', "error");
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            const copiedMessageEl = document.getElementById('copiedMessage');
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    if(copiedMessageEl) copiedMessageEl.classList.remove('hidden');
                    setTimeout(() => { if(copiedMessageEl) copiedMessageEl.classList.add('hidden'); }, 2500);
                } else {
                    console.error('Fallback document.execCommand("copy") falhou.');
                    displayMessage('Falha ao copiar para a área de transferência.', "error");
                }
            } catch (err) {
                console.error('Erro no fallback document.execCommand("copy"):', err);
                displayMessage('Erro ao copiar. Verifique o console.', "error");
            }
            document.body.removeChild(textArea);
        }

        document.addEventListener('DOMContentLoaded', initializeAppCore);
    </script>
</body>
</html>
